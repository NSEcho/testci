name: CI

on: push

jobs:
  build-arm:
    runs-on: windows-11-arm
    steps:
      - name: Install MinGW toolchain for cgo support
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          install: mingw-w64-clang-aarch64-clang
      - name: Install Go toolchain
        uses: actions/setup-go@v5
      - name: Clone frida
        run: |
          git clone https://github.com/frida/frida.git ffrida && cd ffrida/
          python3 tools/ensure-submodules.py frida-core
          cd subprojects/frida-core
          git remote set-url origin https://github.com/NSEcho/frida-core.git && git fetch origin correct_split:correct_split && git checkout correct_split
      - name: Build
        run: |
          cd ffrida/subprojects/frida-core
          .\configure --enable-compiler-backend --with-devkits core
          .\make
        env:
          MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
  build-x86:
    runs-on: windows-latest
    steps:
      - name: Install MinGW toolchain for cgo support
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: mingw-w64-x86_64-gcc
      - name: Install Go toolchain
        uses: actions/setup-go@v5
      - name: Clone frida
        run: |
          git clone https://github.com/frida/frida.git ffrida && cd ffrida/
          python3 tools/ensure-submodules.py frida-core
          cd subprojects/frida-core
          git remote set-url origin https://github.com/NSEcho/frida-core.git && git fetch origin correct_split:correct_split && git checkout correct_split
      - name: Build
        run: |
          cd ffrida/subprojects/frida-core
          .\configure --enable-compiler-backend --with-devkits core
          .\make
        env:
          MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
  build-i686:
    runs-on: windows-latest
    steps:
      - name: Install MinGW toolchain for cgo support
        id: msys2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          install: mingw-w64-i686-gcc
      - name: Install Go toolchain
        uses: actions/setup-go@v5
      - name: Clone frida
        run: |
          git clone https://github.com/frida/frida.git ffrida && cd ffrida/
          python3 tools/ensure-submodules.py frida-core
          cd subprojects/frida-core
          git remote set-url origin https://github.com/NSEcho/frida-core.git && git fetch origin correct_split:correct_split && git checkout correct_split
      - name: Build
        run: |
          cd ffrida/subprojects/frida-core
          .\configure --enable-compiler-backend --with-devkits core
          .\make
        env:
          MSYS2_LOCATION: ${{ steps.msys2.outputs.msys2-location }}
      #- name: Upload
       # uses: actions/upload-artifact@v4
        #with:
         # name: hehe.lib 
          #path: D:\a\testci\testci\builderino\frida-core.lib
      #- name: Test
       # run: |
        #  cd ffrida/subprojects/frida-core
         # .\make test
